LOG ARCHIVING AND COLD STORAGE DOC	Started: 2024-07-04	Updated: 2024-07-04


This document covers the options for archiving of specific log tables and the new "Cold Storage" features



--------------------------------------------------------------------------------
LOG ARCHIVING:

On a high-volume VICIdial system, some log tables can grow very large, resulting in performance issues on the database server. To help mitigate this, we created a log archiving script back in 2009("ADMIN_archive_log_tables.pl") to move log records from specific database log tables to their associated "_archive" log tables. This archive script has grown over the years to add archiving of more log tables and even optional purging(deleting rows from) specific archive and log tables if desired.

NOTE: the "ADMIN_archive_log_tables.pl" script can take hours to run depending on the settings used, the number of log records in your system and the speed of your database server. As such, you should only run this script during non-production hours.

For reference, here are the optional commands for the log archiving script:


# /usr/share/astguiclient/ADMIN_archive_log_tables.pl --help
allowed run time options:
  [--daily] = only archives call_log, vicidial_log_extended, vicidial_dial_log and vicidial_drop_log tables, only last 24 hours kept
  [--carrier-daily] = will also archive the vicidial_carrier_log table when --daily is run
  [--vlog-daily] = will also archive the vicidial_log table when --daily is run
  [--days=XX] = number of days to archive past, default is 732(2 years)
  [--months=XX] = number of months to archive past, default is 24(2 years) If 'days' used then 'months' ignored
  [--queue-log] = archive QM queue_log records
  [--only-trim-archive-level-one] = will not perform normal archive process, instead this will only delete records
                                    that are older than XX months from least important log archive tables:
                               call_log_archive, vicidial_log_extended_archive, vicidial_dial_log_archive, vicidial_drop_log
  [--only-trim-archive-level-two] = same as --only-trim-archive-level-one, except includes tables:
                               vicidial_carrier_log_archive, vicidial_api_log_archive, vicidial_rt_monitor_log_archive
  [--only-trim-archive-level-three] = same as --only-trim-archive-level-two, except includes tables:
                               vicidial_log_archive, vicidial_agent_log_archive, vicidial_closer_log_archive, vicidial_xfer_log_archive
  [--recording-log-days=XX] = OPTIONAL, number of days to archive recording_log table only past
  [--did-log-days=XX] = OPTIONAL, number of days to archive vicidial_did_log table only past
  [--park-log-days=XX] = OPTIONAL, number of days to archive park_log table only past
  [--api-only] = OPTIONAL, only archive vicidial_api_log table then exit
       [--api-log-days=XX] = REQUIRED FOR --api-only, number of days to archive vicidial_api_log table only past
  [--api-archive-only] = OPTIONAL, only purge vicidial_api_log_archive table then exit
       [--api-archive-days=XX] = REQUIRED FOR --api-archive-only, number of days to purge vicidial_api_log_archive table only past
  [--url-log-only] = OPTIONAL, only purge vicidial_url_log table then exit
       [--url-log-days=XX] = REQUIRED FOR --url-log-only, number of days to purge vicidial_url_log table only past
  [--cpd-log-purge-days=XX] = OPTIONAL, number of days to purge vicidial_cpd_log table only past
  [--wipe-closer-log] = OPTIONAL, deletes all records from vicidial_closer_log after archiving
  [--wipe-all-being-archived] = OPTIONAL, deletes all records from most tables after archiving
  [--quiet] = quiet
  [--calc-test] = date calculation test only
  [--test] = test
  [--debug] = debug output for some options


Here are some example crorntab entries for this script to perform certain log archiving and purging:
(these should only be active on a single server on your VICIdial cluster)


### archive logs weekly on Saturday morning at 1am, keep only 2 years of logs in the active log tables, archive older log records
20 1 * * 6 /usr/share/astguiclient/ADMIN_archive_log_tables.pl --months=24

### archive api log entries older than 1 day, do this every night at 12:10 AM
10 0 * * * /usr/share/astguiclient/ADMIN_archive_log_tables.pl --api-only --api-log-days=1

### delete api log entries older than 7 days, do this on Sunday morning at 1:15AM
15 1 * * 0 /usr/share/astguiclient/ADMIN_archive_log_tables.pl --api-archive-only --api-archive-days=7

### delete url log entries older than 7 days, do this on Sunday morning at 1:05AM
5 1 * * 6 /usr/share/astguiclient/ADMIN_archive_log_tables.pl --url-log-only --url-log-days=7 --debugX

### for a very  high-volume inbound cluster, archive logs older than 1 day, including recording log, clear the closer log table and archive did log entries past 31 days
3 1 * * 0,1,2,3,4,5,6 /usr/share/astguiclient/ADMIN_archive_log_tables.pl --days=1 --recording-log-days=1 --wipe-closer-log --wipe-all-being-archived --did-log-days=31

### purge(delete) level-three archive log table records older than 92 days
15 21 * * 5 /usr/share/astguiclient/ADMIN_archive_log_tables.pl --debug --only-trim-archive-level-three --days=92






--------------------------------------------------------------------------------
ARCHIVED LOG COLD STORAGE:

In July 2024, we added some basic options to allow for the moving of already archived log records from the primary database server to a separate database server to allow for more efficient use of the primary database server while still having limited access to very old log records without losing them entirely by deleting them.

Admin access to cold-storage logs is currently available through the following pages:
- Admin Lead Search Page
- Admin Modify Lead Page




The "ADMIN_cold_storage_log_tables.pl" script was added to move archived log records from the primary database to a separate "cold storage" database server. This "cold storage" database server should have the standard vicidial log tables loaded on it, BUT it should NEVER have any live agents or calls running through it, the purpose of this "cold storage" database server is ONLY for storage of old log records. The archived log records on the "cold storage" database server will be stored in the same "_archive" log tables that they were on the primary database server, the reasons for this are: to make programming these features easier, to allow for easier integration of cold-storage logs into existing reporting and admin utilities, and to possibly allow for multiple-level cold-storage in the future.

We added new settings to the /etc/astguiclient.conf file that will run the "ADMIN_cold_storage_log_tables.pl" script, these credentials should allow for read-write access(see example "GRANT" statement below):

# default cold storage logs database server variables: 
$VARCS_server =	'';
$VARCS_database =	'asterisk_coldstorage';
$VARCS_user =	'coldstorage';
$VARCS_pass =	'cs1234';
$VARCS_port =	'3306';

GRANT SELECT,INSERT,UPDATE,DELETE,LOCK TABLES on asterisk_coldstorage.* TO coldstorage@'%' IDENTIFIED BY 'cs1234';
GRANT SELECT,INSERT,UPDATE,DELETE,LOCK TABLES on asterisk_coldstorage.* TO coldstorage@localhost IDENTIFIED BY 'cs1234';
flush privileges;


We also added system_settings fields for read-only access to the cold-storage database server:
NOTE: You should use a separate database read-only user for the below credentials(see example "GRANT" statement below)

ALTER TABLE system_settings ADD coldstorage_server_ip VARCHAR(50) default '';
ALTER TABLE system_settings ADD coldstorage_dbname VARCHAR(50) default '';
ALTER TABLE system_settings ADD coldstorage_login VARCHAR(50) default '';
ALTER TABLE system_settings ADD coldstorage_pass VARCHAR(50) default '';
ALTER TABLE system_settings ADD coldstorage_port VARCHAR(10) default '';

GRANT SELECT,LOCK TABLES on asterisk_coldstorage.* TO csread@'%' IDENTIFIED BY 'csr1234';
GRANT SELECT,LOCK TABLES on asterisk_coldstorage.* TO csread@localhost IDENTIFIED BY 'csr1234';
flush privileges;


The "ADMIN_cold_storage_log_tables.pl" script has a reduced set of options, with the "--days=X" option being the most important one:

 # /usr/share/astguiclient/ADMIN_cold_storage_log_tables.pl --help
allowed run time options:
  [--days=XX] = number of days to archive past, default is 1461(4 years)
  [--quiet] = quiet
  [--calc-test] = date calculation test only
  [--test] = test
  [--debug] = debug output for some options
  [--debugX] = extra debug output for some options


Here is a list of the archive tables that are currently moved by the "ADMIN_cold_storage_log_tables.pl" script:

call_log_archive
vicidial_agent_log_archive
vicidial_agent_visibility_log_archive
vicidial_amd_log_archive
vicidial_api_log_archive
vicidial_api_urls_archive
vicidial_carrier_log_archive
vicidial_dial_cid_log_archive
vicidial_dial_log_archive
vicidial_log_archive
vicidial_log_extended_archive
vicidial_log_extended_sip_archive
